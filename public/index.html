<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anonymous Stats Demo</title>
  <script type="importmap">
  {
    "imports": {
      "vue": "https://esm.sh/vue@3.5.22",
      "hashkeys": "https://esm.sh/hashkeys@0.2.1",
      "@scure/base": "https://esm.sh/@scure/base@2.0.0",
      "@noble/hashes/utils": "https://esm.sh/@noble/hashes@1.4.0/utils"
    }
  }
  </script>
</head>

<body>
  <div id="app">
    <h1>Anonymous Statistics Demo</h1>
    <div id="status">Initializing...</div>
    <div id="output"></div>
    <button id="ping" disabled>Send Stats Ping</button>
    <hr>
     <button id="stats">Load Stats</button>
     <div id="statsEl"></div>
  </div>

  <script type="module">
    import { watch } from 'vue';
    import { useAuth } from 'hashkeys';
    import { bech32 } from '@scure/base';
    import { bytesToHex, utf8ToBytes } from '@noble/hashes/utils';

    const auth = useAuth('hk');
    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');
    const pingBtn = document.getElementById('ping');
    const statsBtn = document.getElementById('stats');
    const statsEl = document.getElementById('statsEl');


    function updateStatus(msg) {
      statusEl.textContent = msg;
    }

    function addOutput(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      outputEl.appendChild(div);
    }

    // Watch auth state
    watch(() => auth.authenticated, (authenticated) => {
      if (authenticated) {
        updateStatus('✓ Authenticated');
        addOutput(`Identity: ${auth.identity}`);
        addOutput(`Public Key: ${auth.publicKey.slice(0, 20)}...`);
        pingBtn.disabled = false;
      } else {
        auth.login(Math.floor(Math.random()*1000000).toString())
      }
    }, {immediate: true});

    watch(() => auth.error, (error) => {
      if (error) {
        updateStatus('✗ Error: ' + error);
      }
    });

    watch(() => auth.loading, (loading) => {
      if (loading) {
        updateStatus('Loading...');
      }
    });

    // Send stats ping
    async function sendStatsPing() {
      try {
        updateStatus('sending message...');

        const response = await fetch('/ingest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pub: auth.publicKey,
          })
        });

        const result = await response.json();

        if (response.ok) {
          updateStatus('✓ Stats ping successful');
          addOutput(`Recorded for ${JSON.stringify(result)}`);
        } else {
          updateStatus('✗ Failed: ' + result.error);
          addOutput(`Error details: ${result.error}`);
        }
      } catch (err) {
        updateStatus('✗ Error: ' + err.message);
        console.error(err);
      }
    }

    // Load stats
    async function loadStats() {
      try {
        updateStatus('loading stats...');

        const response = await fetch('/api/stats');
        const result = await response.json();
        console.log(result)
        if (response.ok) {
          updateStatus('✓ Stats loaded successfully');
          statsEl.textContent = JSON.stringify(result, null, 2);
        } else {
          updateStatus('✗ Failed: ' + result.error);
          statsEl.textContent = `Error details: ${result.error}`;
        }
      } catch (err) {
        updateStatus('✗ Error: ' + err.message);
        console.error(err);
      }
    }

    // Manual trigger
    pingBtn.addEventListener('click', sendStatsPing);
    statsBtn.addEventListener('click', loadStats);

  </script>
</body>

</html>